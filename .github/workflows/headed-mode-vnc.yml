name: Playwright Tests with VNC Viewing
on:
  workflow_dispatch:
    inputs:
      enable_vnc:
        description: 'Enable VNC for headed mode viewing'
        required: false
        default: false
        type: boolean
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'smoke'
        type: choice
        options:
        - smoke
        - critical
        - regression

jobs:
  test-with-vnc:
    runs-on: ubuntu-latest
    if: github.event.inputs.enable_vnc == 'true'
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ–¥ï¸ Setup VNC Server
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb x11vnc fluxbox
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 3
        fluxbox &
        x11vnc -display :99 -nopw -listen localhost -xkb -rfbport 5900 -rfbportv6 5900 -6 &
        echo "VNC Server started on display :99"
    
    - name: ğŸ”§ Install dependencies
      run: |
        npm ci
        npx playwright install
    
    - name: ğŸ§ª Run tests in headed mode
      env:
        DISPLAY: :99
        BASE_URL: ${{ secrets.BASE_URL }}
        TEST_USER_USERNAME: ${{ secrets.TEST_USER_USERNAME }}
        TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
      run: |
        echo "Running tests in headed mode with VNC..."
        npm run test:${{ github.event.inputs.test_suite }} -- --headed
    
    - name: ğŸ“Š Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-headed-mode
        path: |
          playwright-report/
          test-results/
          reports/
